##########################################################
# Shuffle 
# Open Source SOAR - it's free
##########################################################

Create a shuffle account
https://shuffler.io/

From the top-left, click 'Workflows'
Name: SOC Automation Project
Enter a description or leave blank
Usecases: select anything
Click Done

{Shuffle-Webhook}
In the left pane, click 'Triggers' at the bottom
Select 'Webhook' then drag/drop onto right pane
Click the Webhook to open it's properties on right-pane
Name: Wazuh-Alerts
Parameters - copy it - this will be added into the Wazuh Manager

{Shuffle-ChangeMe}
Click the 'Change Me' icon
Find Actions: Repeat back to me
Call: $exec (click the plus button, then Execution Argument)

# SSH into Wazuh
nano /var/ossec/etc/ossec.conf

{Shuffle-Webhook-URL}
# Scroll below the <global> tag
# Paste the <integration> tag
# <integration> tag is found in Wazuh documentation
# https://documentation.wazuh.com/
# Leave a space after the shuffle URL to the tag ends properly
# The <level> is replaced with <rule_id>
# Rule_ID was the custom rule created in Wazuh web

 <integration>
    <name>shuffle</name>
    <hook_url><YOUR_SHUFFLE_URL> </hook_url>
    <rule_id>100002</rule_id>
    <alert_format>json</alert_format>
  </integration>

#To Save
ctrl + x to Exit
ctrl + y for Yes
Enter to save

# Whenever you update a config file, restart the service
systemctl restart wazuh-manager.service

# Confirm the service is running
systemctl status wazuh-manager.service


Spin up the Windows 10 VM
Open PowerShell
Run mimiktaz to regenerate telemetry 

{Shuffle-Webhook-Execution}
Return to Shuffle
Click the Webhook then 'START' (from it's properties pane)
You'll see new events
Select an event and view its details

The overall Shuffle Workflow
1. Mimikatz Alert Sent to Shuffle 
Mimikatz is run from the Windows 10 VM


2. Shuffle Receives Mimikatz Alert 
Shuffle Webhook is created to capture the trigger {Shuffle-Webhook}
SSH into Wazuh, modify ossec.conf to integrate Shuffle URL {Shuffle-Webhook-URL}


3. Check Reputation Score with VirusTotal
Open a Webhook trigger to get hash {Shuffle-Webhook-Hash}
Parse the hash using Regex {Shuffle-Regex}
Create an account with VirusTotal
Add VirusTotal app into Shuffle
VirusTotal workflow will search the has from RegEx {Shuffle-VirusTotal}
You can then check the score on VirusTotal web for case management {Shuffle-VirusTotal-Web}


4. Send Details to TheHive to Create Alert
Log into TheHive web and create two accounts {TheHive-User-Accounts}
  - AnyName@test.com  used to create a new organization outside of "admin"
  - shuffle@test.com  service account set with API key for Shuffle
Add theHive app into Shuffle and authenticate it with the service account API
TheHive app will send alerts to TheHive web on port 9000
Update the cloud Firewall to allow inbound on port 9000 {Firewall-Rules-TheHive}
TheHive cloud now receives alert {TheHive-Alert}	


5. Send an Email to SOC Analyst to being Investigation
Add Email app into Shuffle and link to VirusTotal
Configure the Email app to send to a recipient with details {SquareX-Email}

